<!DOCTYPE html>
<html lang="en" class="bg-gray-50">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> BuellDocs Paystub Generator Pro</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter for UI, Lexend for headings -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lexend:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        // Customizations for Tailwind to use the 'Inter' and 'Lexend' font families
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Lexend', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* A few minor style overrides for better presentation */
        body { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Lexend', sans-serif; }
        .form-group { margin-bottom: 1rem; }
        .dynamic-row, .readonly-row { margin-bottom: 0.5rem; }
        .dynamic-input-desc, .dynamic-input-rate, .dynamic-input-hours, .dynamic-input-current, .dynamic-input-ytd {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.875rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
        }
        .remove-row-btn {
            background-color: #EF4444; color: white; border: none; border-radius: 9999px;
            width: 1.5rem; height: 1.5rem; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .add-row-btn {
            background-color: #22C55E; color: white; border: none; border-radius: 0.375rem;
            padding: 0.5rem 1rem; font-weight: 500; cursor: pointer; margin-top: 0.5rem;
        }
        .tax-value-current, .tax-value-ytd {
            display: block;
            text-align: right;
            padding-right: 0.5rem;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .preview-container table { width: 100%; border-collapse: collapse; }
        .preview-container th, .preview-container td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        /* Ensure inputs don't get browser default styling that overrides Tailwind */
        input, select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-display font-bold text-gray-900">BuellDocs Pro Paystub Generator</h1>
            <p class="mt-2 text-lg text-gray-600">Instantly create professional paystubs with accurate tax calculations.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Side: Input Form -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <form id="paystub-form">
                    <!-- Company & Employee Info -->
                    <div class="mb-6 border-b pb-4">
                        <h3 class="text-xl font-display font-semibold mb-4 text-indigo-700">Company & Employee</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="form-group"><label for="companyName" class="block text-sm font-medium text-gray-700">Company Name</label><input type="text" id="companyName" value="Buell Consulting, Inc." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                            <div class="form-group"><label for="employeeName" class="block text-sm font-medium text-gray-700">Employee Name</label><input type="text" id="employeeName" value="Matthew Buell" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                        </div>
                    </div>

                    <!-- Pay Period & Dates -->
                    <div class="mb-6 border-b pb-4">
                         <h3 class="text-xl font-display font-semibold mb-4 text-indigo-700">Pay Period</h3>
                         <div class="grid grid-cols-2 gap-4">
                            <div class="form-group col-span-2"><label for="payFrequency" class="block text-sm font-medium text-gray-700">Pay Frequency</label><select id="payFrequency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"><option>Bi-Weekly</option><option>Weekly</option><option>Semi-Monthly</option><option>Monthly</option></select></div>
                            <div class="form-group"><label for="payPeriodStart" class="block text-sm font-medium text-gray-700">Period Start</label><input type="date" id="payPeriodStart" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                            <div class="form-group"><label for="payPeriodEnd" class="block text-sm font-medium text-gray-700">Period End</label><input type="date" id="payPeriodEnd" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                            <div class="form-group col-span-2"><label for="payDate" class="block text-sm font-medium text-gray-700">Pay Date</label><input type="date" id="payDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                            <div class="form-group col-span-2"><label for="numPaystubs" class="block text-sm font-medium text-gray-700">Number of Paystubs</label><input type="number" id="numPaystubs" value="1" min="1" max="52" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></div>
                         </div>
                    </div>
                     <!-- Tax Information -->
                    <div class="mb-6 border-b pb-4">
                        <h3 class="text-xl font-display font-semibold mb-4 text-indigo-700">Tax Information</h3>
                        <div class="grid grid-cols-6 gap-4">
                            <div class="form-group col-span-2">
                                <label for="fedFilingStatus" class="block text-sm font-medium text-gray-700">Fed Filing Status</label>
                                <select id="fedFilingStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option>Single</option>
                                    <option>Married</option>
                                </select>
                            </div>
                            <div class="form-group col-span-2">
                                <label for="fedAllowances" class="block text-sm font-medium text-gray-700">Federal Allowances</label>
                                <input id="fedAllowances" type="number" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="form-group col-span-2">
                                <label for="addlFedWithholding" class="block text-sm font-medium text-gray-700">Addl Fed Withholding ($)</label>
                                <input id="addlFedWithholding" type="number" step="0.01" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="form-group col-span-3">
                                <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                                <select id="state" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option>NJ</option>
                                </select>
                            </div>
                            <div class="form-group col-span-3">
                                <label for="stateFilingStatus" class="block text-sm font-medium text-gray-700">State Filing Status</label>
                                <select id="stateFilingStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="A">A</option>
                                    <option value="B" selected>B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="E">E</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Earnings -->
                    <div class="mb-6 border-b pb-4">
                        <h3 class="text-xl font-display font-semibold mb-2 text-indigo-700">Earnings</h3>
                        <div class="grid grid-cols-12 gap-x-2 text-xs font-bold text-gray-500 mb-2">
                            <div class="col-span-4">Description</div>
                            <div class="col-span-2">Rate</div>
                            <div class="col-span-2">Hours</div>
                            <div class="col-span-3">Current Pay</div>
                        </div>
                        <div id="earnings-rows">
                            <!-- Dynamic earnings rows will be injected here -->
                            <div class="grid grid-cols-12 gap-x-2 items-center dynamic-row">
                                <div class="col-span-4"><input type="text" value="Regular Pay" class="dynamic-input-desc"></div>
                                <div class="col-span-2"><input type="number" step="0.01" value="31.25" class="dynamic-input-rate"></div>
                                <div class="col-span-2"><input type="number" step="0.01" value="80" class="dynamic-input-hours"></div>
                                <div class="col-span-3"><input type="text" disabled class="dynamic-input-current bg-gray-100"></div>
                                <div class="col-span-1"><button class="remove-row-btn">X</button></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center dynamic-row">
                                <div class="col-span-4"><input type="text" value="Overtime Pay" class="dynamic-input-desc"></div>
                                <div class="col-span-2"><input type="number" step="0.01" placeholder="Auto" class="dynamic-input-rate" data-rate-multiplier="1.5" readonly></div>
                                <div class="col-span-2"><input type="number" step="0.01" placeholder="0" class="dynamic-input-hours"></div>
                                <div class="col-span-3"><input type="text" disabled class="dynamic-input-current bg-gray-100"></div>
                                <div class="col-span-1"><button class="remove-row-btn">X</button></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center dynamic-row">
                                <div class="col-span-4"><input type="text" value="PTO Pay" class="dynamic-input-desc"></div>
                                <div class="col-span-2"><input type="number" step="0.01" placeholder="Auto" class="dynamic-input-rate" data-rate-multiplier="1.0" readonly></div>
                                <div class="col-span-2"><input type="number" step="0.01" placeholder="0" class="dynamic-input-hours"></div>
                                <div class="col-span-3"><input type="text" disabled class="dynamic-input-current bg-gray-100"></div>
                                <div class="col-span-1"><button class="remove-row-btn">X</button></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center dynamic-row">
                                <div class="col-span-4"><input type="text" value="Bonus" class="dynamic-input-desc"></div>
                                <div class="col-span-2"><input type="number" step="0.01" placeholder="N/A" class="dynamic-input-rate" disabled></div>
                                <div class="col-span-2"><input type="number" step="0.01" placeholder="Amount" class="dynamic-input-hours"></div>
                                <div class="col-span-3"><input type="text" disabled class="dynamic-input-current bg-gray-100"></div>
                                <div class="col-span-1"><button class="remove-row-btn">X</button></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center dynamic-row" data-nontaxable="true">
                                <div class="col-span-4"><input type="text" value="Reimbursement" class="dynamic-input-desc"></div>
                                <div class="col-span-2"><input type="number" step="0.01" placeholder="N/A" class="dynamic-input-rate" disabled></div>
                                <div class="col-span-2"><input type="number" step="0.01" placeholder="Amount" class="dynamic-input-hours"></div>
                                <div class="col-span-3"><input type="text" disabled class="dynamic-input-current bg-gray-100"></div>
                                <div class="col-span-1"><button class="remove-row-btn">X</button></div>
                            </div>
                        </div>
                        <button id="add-earning-btn" type="button" class="add-row-btn">Add Earning</button>
                    </div>

                    <!-- Deductions -->
                    <div class="mb-6">
                        <h3 class="text-xl font-display font-semibold mb-2 text-indigo-700">Deductions</h3>
                        <div class="grid grid-cols-12 gap-x-2 text-xs font-bold text-gray-500 mb-2">
                            <div class="col-span-5">Description</div>
                            <div class="col-span-3">Current</div>
                            <div class="col-span-3">YTD</div>
                        </div>
                        <div id="deductions-rows">
                            <!-- Dynamic deductions rows will be injected here -->
                            <div class="grid grid-cols-12 gap-x-2 items-center dynamic-row">
                                <div class="col-span-5"><input type="text" value="Health Insurance" class="dynamic-input-desc"></div>
                                <div class="col-span-3"><input type="number" step="0.01" value="150" class="dynamic-input-current"></div>
                                <div class="col-span-3"><input type="number" step="0.01" value="3600" class="dynamic-input-ytd"></div>
                                <div class="col-span-1"><button class="remove-row-btn">X</button></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center dynamic-row">
                                <div class="col-span-5"><input type="text" value="401k" class="dynamic-input-desc"></div>
                                <div class="col-span-3"><input type="number" step="0.01" value="125" class="dynamic-input-current"></div>
                                <div class="col-span-3"><input type="number" step="0.01" value="3000" class="dynamic-input-ytd"></div>
                                <div class="col-span-1"><button class="remove-row-btn">X</button></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center dynamic-row">
                                <div class="col-span-5"><input type="text" value="Garnishment" class="dynamic-input-desc"></div>
                                <div class="col-span-3"><input type="number" step="0.01" placeholder="0.00" class="dynamic-input-current"></div>
                                <div class="col-span-3"><input type="number" step="0.01" placeholder="0.00" class="dynamic-input-ytd"></div>
                                <div class="col-span-1"><button class="remove-row-btn">X</button></div>
                            </div>
                        </div>
                        <button id="add-deduction-btn" type="button" class="add-row-btn">Add Deduction</button>
                        
                        <!-- Read-only tax rows -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-500 col-span-12 mb-2">Taxes (Calculated)</h4>
                             <div class="grid grid-cols-12 gap-x-2 items-center readonly-row py-1">
                                <div class="col-span-5"><span class="text-sm text-gray-800">Federal Tax</span></div>
                                <div class="col-span-3"><span data-id="federalTax" class="tax-value-current">0.00</span></div>
                                <div class="col-span-3"><span data-id="federalTaxYtd" class="tax-value-ytd">0.00</span></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center readonly-row py-1">
                                <div class="col-span-5"><span class="text-sm text-gray-800">Social Security</span></div>
                                <div class="col-span-3"><span data-id="socialSecurity" class="tax-value-current">0.00</span></div>
                                <div class="col-span-3"><span data-id="socialSecurityYtd" class="tax-value-ytd">0.00</span></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center readonly-row py-1">
                                <div class="col-span-5"><span class="text-sm text-gray-800">Medicare</span></div>
                                <div class="col-span-3"><span data-id="medicare" class="tax-value-current">0.00</span></div>
                                <div class="col-span-3"><span data-id="medicareYtd" class="tax-value-ytd">0.00</span></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center readonly-row py-1">
                                <div class="col-span-5"><span class="text-sm text-gray-800">State Tax</span></div>
                                <div class="col-span-3"><span data-id="stateTax" class="tax-value-current">0.00</span></div>
                                <div class="col-span-3"><span data-id="stateTaxYtd" class="tax-value-ytd">0.00</span></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center readonly-row py-1">
                                <div class="col-span-5"><span class="text-sm text-gray-800">NJ SUI</span></div>
                                <div class="col-span-3"><span data-id="sui" class="tax-value-current">0.00</span></div>
                                <div class="col-span-3"><span data-id="suiYtd" class="tax-value-ytd">0.00</span></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center readonly-row py-1">
                                <div class="col-span-5"><span class="text-sm text-gray-800">NJ SDI</span></div>
                                <div class="col-span-3"><span data-id="sdi" class="tax-value-current">0.00</span></div>
                                <div class="col-span-3"><span data-id="sdiYtd" class="tax-value-ytd">0.00</span></div>
                            </div>
                            <div class="grid grid-cols-12 gap-x-2 items-center readonly-row py-1">
                                <div class="col-span-5"><span class="text-sm text-gray-800">NJ FLI</span></div>
                                <div class="col-span-3"><span data-id="fli" class="tax-value-current">0.00</span></div>
                                <div class="col-span-3"><span data-id="fliYtd" class="tax-value-ytd">0.00</span></div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="generate-stubs" class="w-full bg-green-600 text-white py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Generate Previews
                    </button>

                </form>
            </div>

            <!-- Right Side: Preview & Download -->
            <div class="lg:col-span-2">
                 <div class="bg-white p-6 rounded-xl shadow-lg sticky top-8">
                     <h3 class="text-2xl font-display font-semibold mb-4 text-center text-indigo-700">Paystub Previews</h3>
                     <div id="previews-container" class="preview-container bg-gray-100 p-4 rounded-lg border border-gray-200 min-h-[400px]">
                         <!-- Previews will be rendered here -->
                          <div class="p-10 text-center text-gray-500">
                            Fill out the form and click "Generate Previews" to see your paystubs.
                          </div>
                     </div>
                     <div id="preview-controls" class="hidden items-center justify-between mt-4">
                        <button id="prev-stub" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">&lt; Prev</button>
                        <span id="stub-counter" class="text-sm font-medium"></span>
                        <button id="next-stub" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Next &gt;</button>
                     </div>

                    <div class="mt-6 text-center">
                        <button id="download-pdf" disabled class="w-full bg-indigo-600 text-white py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            Pay &amp; Download PDF
                        </button>
                        <div id="paypal-button-container" class="mt-6 hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 py-6 border-t border-gray-200">
            <p class="text-sm text-gray-500">&copy; <span id="footer-year"></span> BuellDocs. All Rights Reserved.</p>
        </footer>
    </div>
    
    <script src="https://www.paypal.com/sdk/js?client-id=CLIENT_ID&currency=USD"></script>
    <script>
    // Self-executing anonymous function to encapsulate the application logic
    (function() {
        'use strict';
        // --- NAMESPACE ---
        const App = {};

        // --- UTILITIES ---
        App.PrecisionMath = {
            add: (a, b) => parseFloat((Number(a) + Number(b)).toFixed(10)),
            subtract: (a, b) => parseFloat((Number(a) - Number(b)).toFixed(10)),
            multiply: (a, b) => parseFloat((Number(a) * Number(b)).toFixed(10)),
            round: (num, places) => Number(Math.round(num + 'e' + places) + 'e-' + places)
        };
        
        // --- TAX DATA (Simplified) ---
        // In a real app, this would be fetched from a server or a more robust data module.
        App.TaxData = {
            federal: {
                '2024': {
                    socialSecurity: { rate: 0.062, limit: 168600 },
                    medicare: { rate: 0.0145, highIncomeThreshold: 200000, highIncomeRate: 0.009 },
                    taxBrackets: {
                        single: [
                            { from: 0, upTo: 11600, rate: 0.10 },
                            { from: 11600, upTo: 47150, rate: 0.12 },
                            { from: 47150, upTo: 100525, rate: 0.22 },
                            { from: 100525, upTo: 191950, rate: 0.24 },
                        ],
                        married: [
                            { from: 0, upTo: 23200, rate: 0.10 },
                            { from: 23200, upTo: 94300, rate: 0.12 },
                            { from: 94300, upTo: 201050, rate: 0.22 },
                            { from: 201050, upTo: 383900, rate: 0.24 },
                        ]
                    }
                }
            },
            state: {
                'NJ': {
                    '2024': {
                        sui: { rate: 0.00425, limit: 42300 },
                        sdi: { rate: 0.000, limit: 42300 }, // Rate is 0% for 2024
                        fli: { rate: 0.0006, limit: 161400 },
                        taxBrackets: {
                            'A': [{ from: 0, upTo: 20000, rate: 0.015054 }, { from: 20000, upTo: 35000, rate: 0.020313 }, { from: 35000, upTo: 40000, rate: 0.030586 }, { from: 40000, upTo: 75000, rate: 0.056077 }],
                            'B': [{ from: 0, upTo: 20000, rate: 0.015054 }, { from: 20000, upTo: 50000, rate: 0.020313 }, { from: 50000, upTo: 70000, rate: 0.027469 }, { from: 70000, upTo: 80000, rate: 0.038169 }],
                            'C': [{ from: 0, upTo: 25000, rate: 0.015054 }, { from: 25000, upTo: 55000, rate: 0.020313 }, { from: 55000, upTo: 75000, rate: 0.027469 }],
                            'D': [{ from: 0, upTo: 35000, rate: 0.015054 }, { from: 35000, upTo: 60000, rate: 0.020313 }],
                            'E': [{ from: 0, upTo: Infinity, rate: 0.015054 }],
                        }
                    }
                }
            }
        };

        // --- FORM MANAGER ---
        class FormManager {
            constructor() {
                this.form = document.getElementById('paystub-form');
                this.setupDateDefaults();
                this.setupDynamicRows();
            }

            setupDateDefaults() {
                const today = new Date();
                const endDate = today.toISOString().split('T')[0];
                document.getElementById('payDate').value = endDate;

                const freq = document.getElementById('payFrequency').value;
                const startDate = new Date(today);
                if (freq === 'Bi-Weekly') startDate.setDate(today.getDate() - 13);
                else if (freq === 'Weekly') startDate.setDate(today.getDate() - 6);
                
                document.getElementById('payPeriodEnd').value = endDate;
                document.getElementById('payPeriodStart').value = startDate.toISOString().split('T')[0];
            }
            
            setupDynamicRows() {
                document.getElementById('add-earning-btn').addEventListener('click', () => this.addEarningRow());
                document.getElementById('add-deduction-btn').addEventListener('click', () => this.addDeductionRow());
                
                // Add event listeners for dynamically added remove buttons
                document.getElementById('earnings-rows').addEventListener('click', e => {
                    if (e.target.classList.contains('remove-row-btn')) e.target.closest('.dynamic-row').remove();
                });
                document.getElementById('deductions-rows').addEventListener('click', e => {
                    if (e.target.classList.contains('remove-row-btn')) e.target.closest('.dynamic-row').remove();
                });
            }

            addEarningRow() {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-x-2 items-center dynamic-row';
                row.innerHTML = `
                    <div class="col-span-4"><input type="text" placeholder="e.g., Commission" class="dynamic-input-desc"></div>
                    <div class="col-span-2"><input type="number" step="0.01" placeholder="Rate" class="dynamic-input-rate"></div>
                    <div class="col-span-2"><input type="number" step="0.01" placeholder="Hours" class="dynamic-input-hours"></div>
                    <div class="col-span-3"><input type="text" disabled class="dynamic-input-current bg-gray-100"></div>
                    <div class="col-span-1"><button class="remove-row-btn">X</button></div>`;
                document.getElementById('earnings-rows').appendChild(row);
            }
            
            addDeductionRow() {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-x-2 items-center dynamic-row';
                row.innerHTML = `
                    <div class="col-span-5"><input type="text" placeholder="e.g., Dental" class="dynamic-input-desc"></div>
                    <div class="col-span-3"><input type="number" step="0.01" placeholder="0.00" class="dynamic-input-current"></div>
                    <div class="col-span-3"><input type="number" step="0.01" placeholder="0.00" class="dynamic-input-ytd"></div>
                    <div class="col-span-1"><button class="remove-row-btn">X</button></div>`;
                document.getElementById('deductions-rows').appendChild(row);
            }

            getDynamicRows(containerId, isEarning = true) {
                const rows = document.querySelectorAll(`#${containerId} .dynamic-row`);
                const rowsData = [];
                rows.forEach(row => {
                    const description = row.querySelector('.dynamic-input-desc')?.value || '';
                    if (!description) return; // Skip empty rows

                    const isNonTaxable = row.dataset.nontaxable === 'true';
                    const rateInput = row.querySelector('.dynamic-input-rate');
                    const rateMultiplier = rateInput ? rateInput.dataset.rateMultiplier : null;

                    if (isEarning) {
                        rowsData.push({
                            description,
                            rate: parseFloat(rateInput?.value) || 0,
                            hours: parseFloat(row.querySelector('.dynamic-input-hours')?.value) || 0,
                            isNonTaxable,
                            rateMultiplier
                        });
                    } else {
                        rowsData.push({
                            description,
                            current: parseFloat(row.querySelector('.dynamic-input-current')?.value) || 0,
                            ytd: parseFloat(row.querySelector('.dynamic-input-ytd')?.value) || 0
                        });
                    }
                });
                return rowsData;
            }

            getFormValues() {
                return {
                    companyName: document.getElementById('companyName').value,
                    employeeName: document.getElementById('employeeName').value,
                    payFrequency: document.getElementById('payFrequency').value,
                    payPeriodStart: document.getElementById('payPeriodStart').value,
                    payPeriodEnd: document.getElementById('payPeriodEnd').value,
                    payDate: document.getElementById('payDate').value,
                    numPaystubs: parseInt(document.getElementById('numPaystubs').value, 10),
                    fedFilingStatus: document.getElementById('fedFilingStatus').value,
                    fedAllowances: parseFloat(document.getElementById('fedAllowances').value) || 0,
                    addlFedWithholding: parseFloat(document.getElementById('addlFedWithholding').value) || 0,
                    state: document.getElementById('state').value,
                    stateFilingStatus: document.getElementById('stateFilingStatus').value,
                    earnings: this.getDynamicRows('earnings-rows', true),
                    deductions: this.getDynamicRows('deductions-rows', false)
                };
            }
        }
        App.FormManager = FormManager;

        // --- PAYSTUB CALCULATOR ---
        class PaystubCalculator {
            constructor() {
                this.taxTables = App.TaxData;
                this.year = '2024'; // Can be made dynamic
            }

            getPayPeriodsPerYear(frequency) {
                const map = { 'Weekly': 52, 'Bi-Weekly': 26, 'Semi-Monthly': 24, 'Monthly': 12 };
                return map[frequency] || 26;
            }

            getFederalTax(taxableIncome, formValues) {
                // Per user request, this logic now includes allowances and additional withholding
                const allowanceDeduction = (formValues.fedAllowances || 0) * 86.54; // $86.54 is a specified fixed value per allowance
                const adjustedIncome = Math.max(0, App.PrecisionMath.subtract(taxableIncome, allowanceDeduction));
                const addlWithholding = formValues.addlFedWithholding || 0;

                const annualIncome = App.PrecisionMath.multiply(adjustedIncome, this.getPayPeriodsPerYear(formValues.payFrequency));
                const brackets = this.taxTables.federal[this.year].taxBrackets[formValues.fedFilingStatus.toLowerCase()];
                
                let annualTax = 0;
                let lastBracketLimit = 0;

                for (const bracket of brackets) {
                    if (annualIncome > lastBracketLimit) {
                        const taxableInBracket = Math.min(annualIncome, bracket.upTo) - lastBracketLimit;
                        annualTax = App.PrecisionMath.add(annualTax, App.PrecisionMath.multiply(taxableInBracket, bracket.rate));
                    }
                    lastBracketLimit = bracket.upTo;
                    if (annualIncome <= bracket.upTo) break;
                }
                
                let periodTax = App.PrecisionMath.round(annualTax / this.getPayPeriodsPerYear(formValues.payFrequency), 2);
                periodTax = App.PrecisionMath.add(periodTax, addlWithholding);
                
                return Math.max(0, periodTax);
            }

            getStateTax(taxableIncome, formValues) {
                const state = formValues.state;
                if (!this.taxTables.state[state]) return 0;
                
                const annualIncome = App.PrecisionMath.multiply(taxableIncome, this.getPayPeriodsPerYear(formValues.payFrequency));
                const brackets = this.taxTables.state[state][this.year].taxBrackets[formValues.stateFilingStatus];
                
                let annualTax = 0;
                let lastBracketLimit = 0;

                for (const bracket of brackets) {
                    if(annualIncome > lastBracketLimit) {
                        const taxableInBracket = Math.min(annualIncome, bracket.upTo) - lastBracketLimit;
                        annualTax += taxableInBracket * bracket.rate;
                    }
                    lastBracketLimit = bracket.upTo;
                    if(annualIncome <= bracket.upTo) break;
                }

                return App.PrecisionMath.round(annualTax / this.getPayPeriodsPerYear(formValues.payFrequency), 2);
            }

            calculateSingle(formValues, ytdData = {}) {
                const { PM } = App.PrecisionMath; // Alias for brevity
                
                const regularPayRate = parseFloat(formValues.earnings.find(e => e.description.toLowerCase().includes('regular'))?.rate) || 0;

                // Calculate current earnings, handling multipliers and non-taxable types
                const earnings = formValues.earnings.map(e => {
                    let rate = parseFloat(e.rate) || 0;
                    if (e.rateMultiplier && regularPayRate > 0) {
                        rate = App.PrecisionMath.multiply(regularPayRate, parseFloat(e.rateMultiplier));
                    }
                    const hours = parseFloat(e.hours) || 0;
                    let current = (e.isNonTaxable || e.description.toLowerCase().includes('bonus')) ? hours : App.PrecisionMath.multiply(rate, hours);
                    return { ...e, rate, current: App.PrecisionMath.round(current, 2) };
                });

                const taxableEarnings = earnings.filter(e => !e.isNonTaxable);
                const nonTaxableTotal = earnings.filter(e => e.isNonTaxable).reduce((acc, e) => App.PrecisionMath.add(acc, e.current), 0);
                const grossPay = taxableEarnings.reduce((acc, e) => App.PrecisionMath.add(acc, e.current), 0);

                // YTD Calculations
                const ytdGross = App.PrecisionMath.add(ytdData.grossPay || 0, grossPay);

                // FICA Taxes
                const fedConfig = this.taxTables.federal[this.year];
                let socialSecurity = 0;
                if (ytdGross < fedConfig.socialSecurity.limit) {
                    const ssTaxable = Math.min(grossPay, App.PrecisionMath.subtract(fedConfig.socialSecurity.limit, ytdData.grossPay || 0));
                    socialSecurity = App.PrecisionMath.multiply(ssTaxable, fedConfig.socialSecurity.rate);
                }
                let medicare = App.PrecisionMath.multiply(grossPay, fedConfig.medicare.rate);

                // State Taxes (NJ specific)
                const stateConfig = this.taxTables.state.NJ[this.year];
                let sui = 0, sdi = 0, fli = 0;
                if (ytdGross < stateConfig.sui.limit) {
                    sui = App.PrecisionMath.multiply(grossPay, stateConfig.sui.rate);
                }
                if (ytdGross < stateConfig.sdi.limit) {
                    sdi = App.PrecisionMath.multiply(grossPay, stateConfig.sdi.rate);
                }
                 if (ytdGross < stateConfig.fli.limit) {
                    fli = App.PrecisionMath.multiply(grossPay, stateConfig.fli.rate);
                }

                const federalTax = this.getFederalTax(grossPay, formValues);
                const stateTax = this.getStateTax(grossPay, formValues);
                
                const totalTaxes = [socialSecurity, medicare, federalTax, stateTax, sui, sdi, fli].reduce(App.PrecisionMath.add, 0);
                const totalDeductions = formValues.deductions.reduce((acc, d) => App.PrecisionMath.add(acc, d.current), 0);
                const netPay = App.PrecisionMath.round(App.PrecisionMath.subtract(App.PrecisionMath.add(grossPay, nonTaxableTotal), App.PrecisionMath.add(totalTaxes, totalDeductions)), 2);

                const updatedYtd = {
                    grossPay: ytdGross,
                    netPay: App.PrecisionMath.add(ytdData.netPay || 0, netPay),
                    taxes: {
                        federalTax: App.PrecisionMath.add(ytdData.taxes?.federalTax || 0, federalTax),
                        socialSecurity: App.PrecisionMath.add(ytdData.taxes?.socialSecurity || 0, socialSecurity),
                        medicare: App.PrecisionMath.add(ytdData.taxes?.medicare || 0, medicare),
                        stateTax: App.PrecisionMath.add(ytdData.taxes?.stateTax || 0, stateTax),
                        sui: App.PrecisionMath.add(ytdData.taxes?.sui || 0, sui),
                        sdi: App.PrecisionMath.add(ytdData.taxes?.sdi || 0, sdi),
                        fli: App.PrecisionMath.add(ytdData.taxes?.fli || 0, fli),
                    },
                    deductions: formValues.deductions.map(d => ({
                        description: d.description,
                        ytd: App.PrecisionMath.add(d.ytd, d.current)
                    }))
                };

                return {
                    grossPay, netPay, earnings, nonTaxableTotal,
                    deductions: formValues.deductions,
                    taxes: { federalTax, socialSecurity, medicare, stateTax, sui, sdi, fli },
                    ytd: updatedYtd
                };
            }

            calculateAll(formValues) {
                const stubs = [];
                let cumulativeYtd = { deductions: formValues.deductions.map(d => ({ description: d.description, ytd: d.ytd })) };
                const intervalDays = { 'Bi-Weekly': 14, 'Weekly': 7 }[formValues.payFrequency] || 14;

                for (let i = 0; i < formValues.numPaystubs; i++) {
                    const currentStubValues = { ...formValues };
                    const endDate = new Date(formValues.payPeriodEnd);
                    endDate.setDate(endDate.getDate() - (intervalDays * i));
                    const startDate = new Date(endDate);
                    startDate.setDate(endDate.getDate() - (intervalDays - 1));
                    
                    currentStubValues.payPeriodEnd = endDate.toISOString().split('T')[0];
                    currentStubValues.payPeriodStart = startDate.toISOString().split('T')[0];
                    
                    const payDate = new Date(formValues.payDate);
                    payDate.setDate(payDate.getDate() - (intervalDays * i));
                    currentStubValues.payDate = payDate.toISOString().split('T')[0];
                    
                    const result = this.calculateSingle(currentStubValues, cumulativeYtd);
                    
                    cumulativeYtd = result.ytd;

                    // Add current period dates to the result for rendering
                    result.payPeriodStart = currentStubValues.payPeriodStart;
                    result.payPeriodEnd = currentStubValues.payPeriodEnd;
                    result.payDate = currentStubValues.payDate;
                    
                    stubs.unshift(result); // Add to beginning to get chronological order
                }
                return stubs;
            }
        }
        App.PaystubCalculator = PaystubCalculator;
        
        // --- PREVIEW UPDATER ---
        class PreviewUpdater {
            constructor() {
                this.stubs = [];
                this.currentIndex = 0;
                this.container = document.getElementById('previews-container');
                this.controls = document.getElementById('preview-controls');
                this.counter = document.getElementById('stub-counter');
            }

            setStubs(stubsData) {
                this.stubs = stubsData;
                this.currentIndex = this.stubs.length - 1; // Start at the most recent stub
                this.updateView();
            }

            updateView() {
                if (this.stubs.length === 0) {
                    this.container.innerHTML = `<div class="p-10 text-center text-gray-500">No stubs to display.</div>`;
                    this.controls.classList.add('hidden');
                    return;
                }
                
                const stubData = this.stubs[this.currentIndex];
                const formVals = new App.FormManager().getFormValues();
                this.container.innerHTML = this.generateStubHTML(stubData, formVals);
                
                this.counter.textContent = `Stub ${this.currentIndex + 1} of ${this.stubs.length}`;
                document.getElementById('prev-stub').disabled = this.currentIndex === 0;
                document.getElementById('next-stub').disabled = this.currentIndex === this.stubs.length - 1;
                this.controls.classList.remove('hidden');

                // Update the tax recap on the main form
                this.updateTaxRecap(stubData);
            }

            updateTaxRecap(stubData) {
                const { taxes, ytd } = stubData;
                const updateField = (id, value) => document.querySelector(`[data-id="${id}"]`).textContent = value.toFixed(2);
                
                updateField('federalTax', taxes.federalTax);
                updateField('socialSecurity', taxes.socialSecurity);
                updateField('medicare', taxes.medicare);
                updateField('stateTax', taxes.stateTax);
                updateField('sui', taxes.sui);
                updateField('sdi', taxes.sdi);
                updateField('fli', taxes.fli);

                updateField('federalTaxYtd', ytd.taxes.federalTax);
                updateField('socialSecurityYtd', ytd.taxes.socialSecurity);
                updateField('medicareYtd', ytd.taxes.medicare);
                updateField('stateTaxYtd', ytd.taxes.stateTax);
                updateField('suiYtd', ytd.taxes.sui);
                updateField('sdiYtd', ytd.taxes.sdi);
                updateField('fliYtd', ytd.taxes.fli);
            }

            generateStubHTML(data, form) {
                const f = (n) => n.toFixed(2); // Format numbers
                const earningsHTML = data.earnings.map(e => `<tr><td>${e.description}</td><td class="text-right">${f(e.rate)}</td><td class="text-right">${e.isNonTaxable ? 'N/A' : f(e.hours)}</td><td class="text-right">${f(e.current)}</td><td class="text-right">${'N/A'}</td></tr>`).join('');
                const deductionsHTML = data.deductions.map(d => `<tr><td>${d.description}</td><td class="text-right">${f(d.current)}</td><td class="text-right">${f(data.ytd.deductions.find(y => y.description === d.description).ytd)}</td></tr>`).join('');
                const taxesHTML = `
                    <tr><td>Federal Tax</td><td class="text-right">${f(data.taxes.federalTax)}</td><td class="text-right">${f(data.ytd.taxes.federalTax)}</td></tr>
                    <tr><td>Social Security</td><td class="text-right">${f(data.taxes.socialSecurity)}</td><td class="text-right">${f(data.ytd.taxes.socialSecurity)}</td></tr>
                    <tr><td>Medicare</td><td class="text-right">${f(data.taxes.medicare)}</td><td class="text-right">${f(data.ytd.taxes.medicare)}</td></tr>
                    <tr><td>State Tax (NJ)</td><td class="text-right">${f(data.taxes.stateTax)}</td><td class="text-right">${f(data.ytd.taxes.stateTax)}</td></tr>
                    <tr><td>NJ SUI</td><td class="text-right">${f(data.taxes.sui)}</td><td class="text-right">${f(data.ytd.taxes.sui)}</td></tr>
                    <tr><td>NJ SDI</td><td class="text-right">${f(data.taxes.sdi)}</td><td class="text-right">${f(data.ytd.taxes.sdi)}</td></tr>
                    <tr><td>NJ FLI</td><td class="text-right">${f(data.taxes.fli)}</td><td class="text-right">${f(data.ytd.taxes.fli)}</td></tr>
                `;
                const totalTaxes = Object.values(data.taxes).reduce(App.PrecisionMath.add, 0);
                const totalDeductions = data.deductions.reduce((acc, d) => App.PrecisionMath.add(acc, d.current), 0);
                const totalYtdTaxes = Object.values(data.ytd.taxes).reduce(App.PrecisionMath.add, 0);
                const totalYtdDeductions = data.ytd.deductions.reduce((acc, d) => App.PrecisionMath.add(acc, d.ytd), 0);

                return `
                    <div id="pdf-content-${this.currentIndex}" class="p-4 bg-white text-xs">
                        <h2 class="text-lg font-bold">${form.companyName}</h2>
                        <p>${form.employeeName}</p>
                        <hr class="my-2"/>
                        <div class="grid grid-cols-3 gap-4">
                            <div><strong>Pay Period:</strong> ${data.payPeriodStart} - ${data.payPeriodEnd}</div>
                            <div><strong>Pay Date:</strong> ${data.payDate}</div>
                            <div class="text-right"><strong>Net Pay: <span class="font-bold text-base">$${f(data.netPay)}</span></strong></div>
                        </div>
                        <hr class="my-2"/>
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-bold mb-1">Earnings</h4>
                                <table class="w-full"><thead><tr><th>Description</th><th class="text-right">Rate</th><th class="text-right">Hours</th><th class="text-right">Current</th><th class="text-right">YTD</th></tr></thead><tbody>${earningsHTML}</tbody><tfoot><tr class="font-bold"><td>Total</td><td></td><td></td><td class="text-right">${f(data.grossPay + data.nonTaxableTotal)}</td><td class="text-right">${f(data.ytd.grossPay + data.nonTaxableTotal)}</td></tr></tfoot></table>
                            </div>
                            <div>
                                <h4 class="font-bold mb-1">Deductions & Taxes</h4>
                                <table class="w-full"><thead><tr><th>Description</th><th class="text-right">Current</th><th class="text-right">YTD</th></tr></thead>
                                <tbody>${deductionsHTML}</tbody>
                                <tbody class="border-t-2 border-gray-400">${taxesHTML}</tbody>
                                <tfoot><tr class="font-bold"><td>Total</td><td class="text-right">${f(totalDeductions + totalTaxes)}</td><td class="text-right">${f(totalYtdDeductions + totalYtdTaxes)}</td></tr></tfoot></table>
                            </div>
                        </div>
                    </div>
                `;
            }

            getCurrentStubHTMLforPDF() {
                // Find the currently displayed stub and return its outerHTML for printing
                return document.getElementById(`pdf-content-${this.currentIndex}`);
            }

            next() {
                if (this.currentIndex < this.stubs.length - 1) {
                    this.currentIndex++;
                    this.updateView();
                }
            }

            prev() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.updateView();
                }
            }
        }
        App.PreviewUpdater = PreviewUpdater;

        // --- UI CONTROLLER ---
        class UIController {
            constructor() {
                this.formManager = new App.FormManager();
                this.calculator = new App.PaystubCalculator();
                this.previewUpdater = new App.PreviewUpdater();
                this.paystubs = []; // To store calculation results

                this.formManager.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.generateAndDisplayStubs();
                });
                
                this.setupEventListeners();
            }

            generateAndDisplayStubs() {
                try {
                    const formValues = this.formManager.getFormValues();
                    this.paystubs = this.calculator.calculateAll(formValues);

                    if (this.paystubs && this.paystubs.length > 0) {
                        this.previewUpdater.setStubs(this.paystubs);
                        this.setupPayPalButton(); // New: Setup PayPal button after successful preview generation
                    } else {
                        document.getElementById('previews-container').innerHTML = `<div class="p-10 text-center text-red-500">Could not generate paystubs. Please check your inputs.</div>`;
                    }
                } catch (error) {
                    console.error("Calculation Error:", error);
                    document.getElementById('previews-container').innerHTML = `<div class="p-10 text-center text-red-500">An error occurred during calculation. Check console for details.</div>`;
                }
            }
            
            setupPayPalButton() {
                const numStubs = this.paystubs.length;
                if (numStubs === 0) return;

                const payPalContainer = document.getElementById('paypal-button-container');
                payPalContainer.innerHTML = ''; // Clear previous button if any
                payPalContainer.classList.remove('hidden');

                const priceMap = {
                    1: '3.25', 2: '5.95', 3: '8.50', 4: '11.20', 5: '13.90',
                    6: '16.60', 7: '19.30', 8: '22.00', 9: '24.70', 10: '27.40',
                    11: '30.10', 12: '32.80'
                };
                let amount = priceMap[numStubs] || App.PrecisionMath.add(32.80, App.PrecisionMath.multiply(numStubs - 12, 2.70)).toFixed(2);

                paypal.Buttons({
                    createOrder: (data, actions) => {
                        return actions.order.create({
                            purchase_units: [{
                                description: `Paystub Generation (${numStubs} stubs)`,
                                amount: { currency_code: 'USD', value: amount }
                            }]
                        });
                    },
                    onApprove: (data, actions) => {
                        return actions.order.capture().then(details => {
                            const downloadBtn = document.getElementById('download-pdf');
                            downloadBtn.disabled = false;
                            downloadBtn.classList.remove('opacity-50', 'disabled:cursor-not-allowed');
                            downloadBtn.click();
                            payPalContainer.classList.add('hidden');
                        });
                    },
                    onError: err => {
                        console.error('PayPal button error:', err);
                        payPalContainer.innerHTML = `<p class="text-red-500 text-sm">An error occurred with the payment process. Please try again.</p>`;
                    }
                }).render('#paypal-button-container');
            }

            setupEventListeners() {
                document.getElementById('download-pdf').addEventListener('click', () => {
                    const elementToPrint = this.previewUpdater.getCurrentStubHTMLforPDF();
                    const numStubs = this.paystubs.length || 1;
                    const formValues = this.formManager.getFormValues();
                    const filename = `Paystubs_${formValues.companyName.replace(/ /g, '_')}_${formValues.employeeName.replace(/ /g, '_')}_(${numStubs}_count).pdf`;
                    
                    const opt = {
                        margin:       [0.25, 0.25, 0.25, 0.25],
                        filename:     filename,
                        image:        { type: 'jpeg', quality: 0.98 },
                        html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
                        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };
                    html2pdf().from(elementToPrint).set(opt).save();
                });

                document.getElementById('next-stub').addEventListener('click', () => this.previewUpdater.next());
                document.getElementById('prev-stub').addEventListener('click', () => this.previewUpdater.prev());
                document.getElementById('footer-year').textContent = new Date().getFullYear();
            }
        }
        App.UIController = UIController;

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            new App.UIController();
        });
    })();
    </script>
</body>

</html>
